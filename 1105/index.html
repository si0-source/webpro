import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { motion } from "framer-motion";
import { RefreshCw, Share2, Sparkles } from "lucide-react";

interface ResultScreenProps {
  answers: string[];
  answerTimes: number[];
  miniGameScores: number[];
  onRestart: () => void;
}

export const ResultScreen = ({ answers, answerTimes, miniGameScores, onRestart }: ResultScreenProps) => {
  // ë‹µë³€ íŒ¨í„´ ë¶„ì„
  const analyzeAnswerPattern = () => {
    // ê°™ì€ ë‹µë³€ì„ ë°˜ë³µì ìœ¼ë¡œ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸
    const answerCounts = answers.reduce((acc, answer) => {
      acc[answer] = (acc[answer] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);
    
    const maxRepeats = Math.max(...Object.values(answerCounts));
    const hasRepeatedPattern = maxRepeats >= 5;
    
    // ë„ˆë¬´ ë¹¨ë¦¬ ë‹µë³€í–ˆëŠ”ì§€ í™•ì¸ (í‰ê·  2ì´ˆ ì´í•˜)
    const averageTime = answerTimes.reduce((sum, time) => sum + time, 0) / answerTimes.length;
    const answeredTooQuickly = averageTime < 2;
    
    return { hasRepeatedPattern, answeredTooQuickly, maxRepeats, averageTime };
  };

  const getComprehensiveResult = () => {
    const { averageTime } = analyzeAnswerPattern();
    const totalMiniGameScore = miniGameScores.reduce((sum, score) => sum + score, 0);
    const avgMiniGameScore = totalMiniGameScore / miniGameScores.length;
    
    // ë‹µë³€ ì†ë„ ì ìˆ˜ (ë¹ ë¥¼ìˆ˜ë¡ ë†’ìŒ, ìµœëŒ€ 30ì )
    const speedScore = Math.min(30, Math.max(0, 30 - averageTime * 3));
    
    // ë¯¸ë‹ˆê²Œì„ ì ìˆ˜ (ìµœëŒ€ 50ì )
    const gameScore = Math.min(50, avgMiniGameScore / 2);
    
    // ë‹µë³€ ì¼ê´€ì„± ì ìˆ˜ (ìµœëŒ€ 20ì ) - ë„ˆë¬´ ë°˜ë³µì ì´ì§€ ì•Šìœ¼ë©´ì„œë„ íŒ¨í„´ì´ ìˆëŠ”ì§€
    const answerCounts = answers.reduce((acc, answer) => {
      acc[answer] = (acc[answer] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);
    const variance = Object.values(answerCounts).reduce((sum, count) => sum + Math.pow(count - answers.length / Object.keys(answerCounts).length, 2), 0);
    const consistencyScore = Math.min(20, variance * 2);
    
    const totalScore = Math.round(speedScore + gameScore + consistencyScore);
    
    // ì´ì ì— ë”°ë¥¸ ìœ í˜• ê²°ì •
    let resultType = "";
    let resultDescription = "";
    let resultDetail = "";
    let resultEmoji = "";
    
    if (totalScore >= 80) {
      resultType = "ì™„ë²½ì£¼ì˜ ë‹¬ì„±ì";
      resultDescription = "ë¹ ë¥¸ íŒë‹¨ë ¥ê³¼ ë›°ì–´ë‚œ ì§‘ì¤‘ë ¥ì„ ë™ì‹œì— ë³´ìœ í•œ ìœ í˜•ì…ë‹ˆë‹¤.";
      resultDetail = "ë‹¹ì‹ ì€ ìƒí™©ì„ ë¹ ë¥´ê²Œ íŒŒì•…í•˜ê³  ì¦‰ê°ì ìœ¼ë¡œ ìµœì„ ì˜ ì„ íƒì„ ë‚´ë¦½ë‹ˆë‹¤. ë¯¸ë‹ˆê²Œì„ì—ì„œë„ ë†’ì€ ì§‘ì¤‘ë ¥ì„ ë³´ì—¬ì£¼ì—ˆê³ , ë‹µë³€ íŒ¨í„´ë„ ì¼ê´€ì„±ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ë‹¹ì‹ ì€ ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë ¤ì•¼ í•˜ëŠ” ìˆœê°„ì— íŠ¹íˆ ë¹›ì„ ë°œí•˜ë©°, ì£¼ë³€ ì‚¬ëŒë“¤ì´ ë¯¿ê³  ë”°ë¥´ëŠ” ë¦¬ë”í˜•ì…ë‹ˆë‹¤. ë‹¤ë§Œ ë•Œë¡œëŠ” ë„ˆë¬´ ì™„ë²½ì„ ì¶”êµ¬í•˜ë‹¤ ë³´ë‹ˆ ì‘ì€ ì‹¤ìˆ˜ì—ë„ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ë°›ì„ ìˆ˜ ìˆìœ¼ë‹ˆ, ê°€ë”ì€ ì—¬ìœ ë¥¼ ê°€ì§€ëŠ” ê²ƒë„ í•„ìš”í•©ë‹ˆë‹¤.";
      resultEmoji = "ğŸ†";
    } else if (totalScore >= 65) {
      resultType = "ë°¸ëŸ°ìŠ¤ ë§ˆìŠ¤í„°";
      resultDescription = "ì‹ ì¤‘í•¨ê³¼ ë¹ ë¥¸ íŒë‹¨ë ¥ì˜ ê· í˜•ì´ ì˜ ì¡íŒ ìœ í˜•ì…ë‹ˆë‹¤.";
      resultDetail = "ë‹¹ì‹ ì€ ìƒí™©ì— ë”°ë¼ ë¹ ë¥´ê²Œ ê²°ì •í•˜ê¸°ë„ í•˜ê³ , í•„ìš”í•  ë•ŒëŠ” ì¶©ë¶„íˆ ê³ ë¯¼í•˜ëŠ” ìœ ì—°ì„±ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ë¯¸ë‹ˆê²Œì„ ì ìˆ˜ì™€ ë‹µë³€ ì†ë„ ëª¨ë‘ ì•ˆì •ì ì´ë©°, ê·¹ë‹¨ì ì´ì§€ ì•Šì€ ì¤‘ë„ì  ì„ íƒì„ ì„ í˜¸í•©ë‹ˆë‹¤. ì´ëŸ° ê· í˜•ê°ê°ì€ íŒ€ í”„ë¡œì íŠ¸ë‚˜ ê·¸ë£¹ í™œë™ì—ì„œ ì¡°ìœ¨ì ì—­í• ì„ í•˜ê¸°ì— ì í•©í•©ë‹ˆë‹¤. ë‹¤ë§Œ ë•Œë¡œëŠ” ìš°ìœ ë¶€ë‹¨í•´ ë³´ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ, ì¤‘ìš”í•œ ìˆœê°„ì—ëŠ” ìì‹ ì˜ ì˜ê²¬ì„ ëª…í™•íˆ í•˜ëŠ” ì—°ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.";
      resultEmoji = "âš–ï¸";
    } else if (totalScore >= 50) {
      resultType = "ì‹ ì¤‘í•œ ì‚¬ìƒ‰ê°€";
      resultDescription = "ì¶©ë¶„í•œ ê³ ë¯¼ ëì— ê²°ì •ì„ ë‚´ë¦¬ëŠ” ì‚¬ë ¤ ê¹Šì€ ìœ í˜•ì…ë‹ˆë‹¤.";
      resultDetail = "ë‹¹ì‹ ì€ ë‹µë³€ì— ì‹œê°„ì„ ì¶©ë¶„íˆ ë“¤ì´ë©°, ê° ì„ íƒì§€ë¥¼ ê¼¼ê¼¼íˆ ê²€í† í•˜ëŠ” ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤. ê¸‰í•˜ê²Œ íŒë‹¨í•˜ê¸°ë³´ë‹¤ëŠ” ëª¨ë“  ê°€ëŠ¥ì„±ì„ ìƒê°í•´ë³¸ í›„ ê²°ì •ì„ ë‚´ë¦½ë‹ˆë‹¤. ì´ëŸ° ì‹ ì¤‘í•¨ì€ ì¤‘ìš”í•œ ê²°ì •ì—ì„œ ì‹¤ìˆ˜ë¥¼ ì¤„ì—¬ì£¼ì§€ë§Œ, ì¼ìƒì ì¸ ì„ íƒì—ì„œëŠ” ë„ˆë¬´ ë§ì€ ì—ë„ˆì§€ë¥¼ ì†Œë¹„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë•Œë¡œëŠ” ì§ê´€ì„ ë¯¿ê³  ë¹ ë¥´ê²Œ ê²°ì •í•˜ëŠ” ì—°ìŠµë„ í•„ìš”í•©ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ê¹Šì´ ìˆëŠ” ì‚¬ê³ ë°©ì‹ì€ ë¬¸ì œ í•´ê²° ëŠ¥ë ¥ì˜ í•µì‹¬ì…ë‹ˆë‹¤.";
      resultEmoji = "ğŸ¤”";
    } else if (totalScore >= 35) {
      resultType = "ììœ ë¡œìš´ íƒí—˜ê°€";
      resultDescription = "ê²°ê³¼ë³´ë‹¤ëŠ” ê³¼ì •ì„ ì¦ê¸°ëŠ” ì—¬ìœ ë¡œìš´ ìœ í˜•ì…ë‹ˆë‹¤.";
      resultDetail = "ë‹¹ì‹ ì€ ì •í•´ì§„ í‹€ì— ì–½ë§¤ì´ì§€ ì•Šê³  ììœ ë¡­ê²Œ ì„ íƒí•˜ëŠ” ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤. ë¯¸ë‹ˆê²Œì„ì—ì„œë„ ì ìˆ˜ì— ì—°ì—°í•˜ê¸°ë³´ë‹¤ëŠ” ì¬ë¯¸ë¥¼ ì¶”êµ¬í•˜ë©°, ë‹µë³€ íŒ¨í„´ë„ ì˜ˆì¸¡í•˜ê¸° ì–´ë ¤ìš´ ë…íŠ¹í•¨ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŸ° ììœ ë¡œì›€ì€ ì°½ì˜ì ì¸ ì•„ì´ë””ì–´ë¥¼ ë‚´ëŠ” ë° ë„ì›€ì´ ë˜ì§€ë§Œ, ë•Œë¡œëŠ” ì¼ê´€ì„± ë¶€ì¡±ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ìƒí™©ì—ì„œëŠ” ì¡°ê¸ˆ ë” ì§‘ì¤‘ë ¥ì„ ë°œíœ˜í•œë‹¤ë©´, ë‹¹ì‹ ì˜ ì°½ì˜ì„±ì´ ë” ë¹›ë‚  ê²ƒì…ë‹ˆë‹¤.";
      resultEmoji = "ğŸ¨";
    } else {
      resultType = "ë§ˆì´ì›¨ì´ ë„ì „ì";
      resultDescription = "ìì‹ ë§Œì˜ ë…íŠ¹í•œ ë°©ì‹ìœ¼ë¡œ ë¬¸ì œì— ì ‘ê·¼í•˜ëŠ” ìœ í˜•ì…ë‹ˆë‹¤.";
      resultDetail = "ë‹¹ì‹ ì€ ë‚¨ë“¤ê³¼ ë‹¤ë¥¸ ì‹œê°ìœ¼ë¡œ ìƒí™©ì„ ë°”ë¼ë³´ë©°, ì „í˜€ ì˜ˆìƒì¹˜ ëª»í•œ ì„ íƒì„ í•˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤. ë‹µë³€ ì‹œê°„ì´ ë¶ˆê·œì¹™í•˜ê³  íŒ¨í„´ë„ ì¼ì •í•˜ì§€ ì•Šì§€ë§Œ, ê·¸ê²ƒì´ ì˜¤íˆë ¤ ë‹¹ì‹ ë§Œì˜ ë…ì°½ì„±ì…ë‹ˆë‹¤. ë‹¤ë§Œ ì´ëŸ° ìŠ¤íƒ€ì¼ì€ ë•Œë¡œ ì£¼ë³€ ì‚¬ëŒë“¤ì´ ì´í•´í•˜ê¸° ì–´ë ¤ìš¸ ìˆ˜ ìˆìœ¼ë‹ˆ, ì¤‘ìš”í•œ ê²°ì •ì—ì„œëŠ” ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ì†Œí†µí•˜ë©° ìƒê°ì„ ê³µìœ í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë…íŠ¹í•œ ê´€ì ì€ ìƒˆë¡œìš´ í•´ê²°ì±…ì„ ì°¾ëŠ” ë° í° ê°•ì ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      resultEmoji = "ğŸ¯";
    }
    
    return {
      totalScore,
      speedScore: Math.round(speedScore),
      gameScore: Math.round(gameScore),
      consistencyScore: Math.round(consistencyScore),
      resultType,
      resultDescription,
      resultDetail,
      resultEmoji,
    };
  };

  const { hasRepeatedPattern, answeredTooQuickly, maxRepeats } = analyzeAnswerPattern();
  const isSpecialResult = hasRepeatedPattern || answeredTooQuickly;
  const comprehensiveResult = getComprehensiveResult();

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.5 }}
      className="w-full max-w-3xl mx-auto px-4"
    >
      <motion.div
        initial={{ scale: 0 }}
        animate={{ scale: 1 }}
        transition={{ delay: 0.2, type: "spring", stiffness: 200 }}
        className="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-accent flex items-center justify-center mx-auto mb-6 shadow-lg"
      >
        <Sparkles className="w-8 h-8 text-white" />
      </motion.div>

      <motion.h1
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.3 }}
        className="text-4xl md:text-5xl font-bold text-center mb-4"
      >
        {isSpecialResult ? "ì ê¹ë§Œìš”! ğŸ¤”" : "ê²°ê³¼ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤!"}
      </motion.h1>

      <motion.p
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.4 }}
        className="text-xl text-muted-foreground text-center mb-12"
      >
        {isSpecialResult 
          ? "ë‹¹ì‹ ì˜ ë‹µë³€ íŒ¨í„´ì´ ì¡°ê¸ˆ íŠ¹ì´í•©ë‹ˆë‹¤..." 
          : "ë‹¹ì‹ ì˜ ë‹µë³€ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤"
        }
      </motion.p>

      <motion.div
        initial={{ y: 30, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.5 }}
      >
        <Card className="p-8 shadow-[var(--shadow-card)] border-border/50 backdrop-blur-sm bg-card/80 mb-6">
          {isSpecialResult ? (
            <div className="text-center mb-6">
              <div className="inline-block px-4 py-2 rounded-full bg-destructive/10 text-destructive font-semibold mb-4">
                íŠ¹ë³„ ê²°ê³¼
              </div>
              <h2 className="text-3xl font-bold mb-4 text-destructive">
                ì„±ì‹¤í•˜ì§€ ì•Šì€ ë‹µë³€ì ìœ í˜•
              </h2>
              <div className="space-y-4 text-left">
                {hasRepeatedPattern && (
                  <div className="p-4 bg-muted rounded-lg">
                    <p className="text-lg font-semibold mb-2">ğŸ”„ ë°˜ë³µ íŒ¨í„´ ê°ì§€</p>
                    <p className="text-muted-foreground">
                      ê°™ì€ ë‹µë³€ì„ <strong className="text-destructive">{maxRepeats}ë²ˆ</strong> ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.
                      ì§„ì§€í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”!
                    </p>
                  </div>
                )}
                {answeredTooQuickly && (
                  <div className="p-4 bg-muted rounded-lg">
                    <p className="text-lg font-semibold mb-2">âš¡ ë„ˆë¬´ ë¹ ë¥¸ ì‘ë‹µ</p>
                    <p className="text-muted-foreground">
                      í‰ê·  ë‹µë³€ ì‹œê°„ì´ <strong className="text-destructive">2ì´ˆ ë¯¸ë§Œ</strong>ì…ë‹ˆë‹¤.
                      ê° ì§ˆë¬¸ì„ ì¶©ë¶„íˆ ê³ ë¯¼í•˜ê³  ë‹µë³€í•´ì£¼ì„¸ìš”.
                    </p>
                  </div>
                )}
                <div className="p-4 bg-primary/5 border border-primary/20 rounded-lg mt-6">
                  <p className="text-center text-muted-foreground">
                    ì •í™•í•œ ê²°ê³¼ë¥¼ ìœ„í•´ ê° ì§ˆë¬¸ì„ ì‹ ì¤‘í•˜ê²Œ ì½ê³ <br />
                    ì†”ì§í•˜ê²Œ ë‹µë³€í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>
          ) : (
            <div className="mb-6">
              <div className="text-center">
                <div className="text-6xl mb-4">{comprehensiveResult.resultEmoji}</div>
                <div className="inline-block px-4 py-2 rounded-full bg-primary/10 text-primary font-semibold mb-4">
                  ë‹¹ì‹ ì˜ ìœ í˜•
                </div>
                <h2 className="text-3xl font-bold mb-3 bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
                  {comprehensiveResult.resultType}
                </h2>
                <p className="text-lg font-semibold text-foreground mb-6">
                  {comprehensiveResult.resultDescription}
                </p>
                <div className="text-center p-6 rounded-lg bg-gradient-to-br from-primary/10 to-accent/10 border-2 border-primary/20 mb-6">
                  <div className="text-sm text-muted-foreground mb-2">ì¢…í•© ì ìˆ˜</div>
                  <div className="text-5xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">
                    {comprehensiveResult.totalScore}
                  </div>
                  <div className="text-xs text-muted-foreground mt-1">/ 100ì </div>
                </div>
              </div>
              
              <div className="mt-6 p-5 rounded-lg bg-muted/30 border border-border/50">
                <h3 className="text-sm font-semibold text-primary mb-3 flex items-center gap-2">
                  <span className="w-1 h-4 bg-primary rounded-full"></span>
                  ì„¸ë¶€ ë¶„ì„
                </h3>
                <p className="text-sm leading-relaxed text-muted-foreground text-left">
                  {comprehensiveResult.resultDetail}
                </p>
              </div>
            </div>
          )}

          {!isSpecialResult && (
            <>
              <div className="border-t border-border pt-6 mt-6">
                <h3 className="font-semibold mb-4 text-lg">ì„¸ë¶€ ì ìˆ˜</h3>
                <div className="space-y-3">
                  <div className="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                    <div className="flex items-center gap-2">
                      <span className="text-2xl">âš¡</span>
                      <span className="text-sm font-medium">íŒë‹¨ ì†ë„</span>
                    </div>
                    <div className="text-xl font-bold text-primary">{comprehensiveResult.speedScore}/30</div>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                    <div className="flex items-center gap-2">
                      <span className="text-2xl">ğŸ®</span>
                      <span className="text-sm font-medium">ë¯¸ë‹ˆê²Œì„ ì‹¤ë ¥</span>
                    </div>
                    <div className="text-xl font-bold text-primary">{comprehensiveResult.gameScore}/50</div>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded-lg bg-muted/50">
                    <div className="flex items-center gap-2">
                      <span className="text-2xl">ğŸ¯</span>
                      <span className="text-sm font-medium">ë‹µë³€ ì¼ê´€ì„±</span>
                    </div>
                    <div className="text-xl font-bold text-primary">{comprehensiveResult.consistencyScore}/20</div>
                  </div>
                </div>
              </div>

              <div className="border-t border-border pt-6 mt-6">
                <h3 className="font-semibold mb-3 text-lg">ë¯¸ë‹ˆê²Œì„ ê°œë³„ ì ìˆ˜</h3>
                <div className="grid grid-cols-3 gap-4">
                  <div className="text-center p-4 rounded-lg bg-muted/50">
                    <div className="text-2xl font-bold text-primary">{miniGameScores[0] || 0}</div>
                    <div className="text-xs text-muted-foreground mt-1">ë°˜ì‘ì†ë„</div>
                  </div>
                  <div className="text-center p-4 rounded-lg bg-muted/50">
                    <div className="text-2xl font-bold text-primary">{miniGameScores[1] || 0}</div>
                    <div className="text-xs text-muted-foreground mt-1">íƒ€ì´ë°</div>
                  </div>
                  <div className="text-center p-4 rounded-lg bg-muted/50">
                    <div className="text-2xl font-bold text-primary">{miniGameScores[2] || 0}</div>
                    <div className="text-xs text-muted-foreground mt-1">ë¦¬ë“¬</div>
                  </div>
                </div>
              </div>
            </>
          )}
        </Card>
      </motion.div>

      <motion.div
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.8 }}
        className="flex flex-col sm:flex-row gap-4 justify-center"
      >
        <Button
          variant="outline"
          size="lg"
          onClick={onRestart}
          className="gap-2"
        >
          <RefreshCw className="w-4 h-4" />
          {isSpecialResult ? "ë‹¤ì‹œ ì§„ì§€í•˜ê²Œ í•˜ê¸°" : "ë‹¤ì‹œ í•˜ê¸°"}
        </Button>
        {!isSpecialResult && (
          <Button
            size="lg"
            className="gap-2 bg-gradient-to-r from-primary to-accent hover:opacity-90"
            onClick={() => {
              // ê³µìœ  ê¸°ëŠ¥ êµ¬í˜„ ê°€ëŠ¥
              alert("ê²°ê³¼ ê³µìœ  ê¸°ëŠ¥ì€ ì¶”í›„ ì¶”ê°€ë©ë‹ˆë‹¤!");
            }}
          >
            <Share2 className="w-4 h-4" />
            ê²°ê³¼ ê³µìœ í•˜ê¸°
          </Button>
        )}
      </motion.div>
    </motion.div>
  );
};
