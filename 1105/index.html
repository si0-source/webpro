<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ˆë¬¸ í…ŒìŠ¤íŠ¸ - ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”</title>
    <meta name="description" content="ëª‡ ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•˜ê³  ë§ì¶¤í˜• ê²°ê³¼ë¥¼ ë°›ì•„ë³´ì„¸ìš”">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
            min-height: 100vh;
            padding: 3rem 1rem;
            color: #0c4a6e;
        }

        .container {
            max-width: 48rem;
            margin: 0 auto;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 8px 30px -4px rgba(8, 145, 178, 0.2);
            animation: slideUp 0.3s ease-out;
        }

        .icon-circle {
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #0891b2 0%, #67e8f9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
        }

        h1 {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #0891b2 0%, #67e8f9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.25rem;
            text-align: center;
            color: #64748b;
            margin-bottom: 3rem;
            line-height: 1.8;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .btn-group {
                flex-direction: row;
                justify-content: center;
            }
        }

        .btn {
            padding: 1.5rem 2rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: scale(1.05);
            border-color: #0891b2;
            background: rgba(8, 145, 178, 0.05);
        }

        .btn-number {
            font-size: 2rem;
            color: #0891b2;
        }

        .btn-text {
            font-size: 0.875rem;
            color: #64748b;
        }

        .btn-time {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: #e2e8f0;
            border-radius: 1rem;
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0891b2 0%, #67e8f9 100%);
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .question-title {
            font-size: 1.875rem;
            font-weight: bold;
            margin-bottom: 2rem;
            color: #0c4a6e;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .option-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.125rem;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .option-btn:hover {
            background: rgba(8, 145, 178, 0.1);
            border-color: #67e8f9;
        }

        .option-letter {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: rgba(8, 145, 178, 0.1);
            color: #0891b2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .game-area {
            height: 24rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2rem 0;
        }

        .game-waiting { background: rgba(148, 163, 184, 0.3); color: #64748b; }
        .game-ready { background: rgba(251, 191, 36, 0.2); color: #d97706; }
        .game-go { background: #10b981; color: white; }
        .game-early { background: rgba(239, 68, 68, 0.2); color: #dc2626; }
        .game-result { background: rgba(148, 163, 184, 0.3); color: #0891b2; }

        .game-timing {
            position: relative;
            background: rgba(148, 163, 184, 0.3);
            overflow: hidden;
        }

        .target-zone {
            position: absolute;
            width: 5rem;
            height: 100%;
            background: rgba(8, 145, 178, 0.1);
            border-left: 2px solid rgba(8, 145, 178, 0.3);
            border-right: 2px solid rgba(8, 145, 178, 0.3);
            left: 50%;
            transform: translateX(-50%);
        }

        .target-line {
            position: absolute;
            width: 0.25rem;
            height: 100%;
            background: #0891b2;
            left: 50%;
            transform: translateX(-50%);
        }

        .timing-bar {
            position: absolute;
            width: 1rem;
            height: 100%;
            background: linear-gradient(90deg, #67e8f9 0%, #0891b2 100%);
            box-shadow: 0 4px 20px rgba(8, 145, 178, 0.5);
        }

        .game-rhythm {
            position: relative;
            background: rgba(148, 163, 184, 0.3);
            overflow: hidden;
        }

        .rhythm-target-line {
            position: absolute;
            width: 100%;
            height: 0.25rem;
            background: rgba(8, 145, 178, 0.5);
            top: 90%;
            animation: pulse 1s infinite;
        }

        .rhythm-target-zone {
            position: absolute;
            width: 100%;
            height: 5rem;
            background: rgba(8, 145, 178, 0.1);
            border-top: 2px solid rgba(8, 145, 178, 0.3);
            border-bottom: 2px solid rgba(8, 145, 178, 0.3);
            top: calc(90% - 2.5rem);
        }

        .rhythm-note {
            position: absolute;
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #0891b2 0%, rgba(8, 145, 178, 0.7) 100%);
            box-shadow: 0 4px 20px rgba(8, 145, 178, 0.5);
            left: 50%;
            transform: translateX(-50%);
        }

        .rhythm-note.hit {
            background: #10b981;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .game-score {
            font-size: 2rem;
            font-weight: bold;
            color: #0891b2;
        }

        .game-timer {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .game-combo {
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            color: #0891b2;
            margin-bottom: 1rem;
        }

        .result-type {
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .result-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            background: rgba(8, 145, 178, 0.1);
            color: #0891b2;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .result-title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #0891b2 0%, #67e8f9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .result-description {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 1.5rem;
        }

        .result-score-box {
            text-align: center;
            padding: 1.5rem;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, rgba(8, 145, 178, 0.1) 0%, rgba(103, 232, 249, 0.1) 100%);
            border: 2px solid rgba(8, 145, 178, 0.2);
            margin-bottom: 1.5rem;
        }

        .result-score-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .result-score-value {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #0891b2 0%, #67e8f9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .result-score-max {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .result-detail-box {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border-radius: 0.75rem;
            background: rgba(148, 163, 184, 0.3);
            border: 1px solid rgba(203, 213, 225, 0.5);
        }

        .result-detail-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0891b2;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .result-detail-text {
            font-size: 0.875rem;
            line-height: 1.7;
            color: #64748b;
            text-align: left;
        }

        .score-breakdown {
            border-top: 1px solid #cbd5e1;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background: rgba(148, 163, 184, 0.5);
            margin-bottom: 0.75rem;
        }

        .score-item-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .score-item-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #0891b2;
        }

        .minigame-scores {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .minigame-score-item {
            text-align: center;
            padding: 1rem;
            border-radius: 0.5rem;
            background: rgba(148, 163, 184, 0.5);
        }

        .minigame-score-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0891b2;
        }

        .minigame-score-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        @media (min-width: 640px) {
            .action-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }

        .action-btn {
            padding: 0.75rem 2rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.75rem;
            background: white;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: #f8fafc;
        }

        .action-btn-primary {
            background: linear-gradient(90deg, #0891b2 0%, #67e8f9 100%);
            color: white;
            border: none;
        }

        .action-btn-primary:hover {
            opacity: 0.9;
        }

        .hidden {
            display: none;
        }

        .game-instruction {
            text-align: center;
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 1rem;
        }

        .feedback-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            animation: feedbackPulse 0.3s ease-out;
        }

        @keyframes feedbackPulse {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1.5); opacity: 1; }
        }

        .feedback-text {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .feedback-perfect { color: #fbbf24; }
        .feedback-good { color: #10b981; }
        .feedback-ok { color: #3b82f6; }
        .feedback-miss { color: #ef4444; }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div id="app" class="container"></div>

    <script>
        // ì§ˆë¬¸ í’€
        const questionPool = [
            { question: "ì¹œêµ¬ê°€ ë‚´ ë¬¼ê±´ì„ í—ˆë½ ì—†ì´ ì¼ì–´ìš”. ì–´ë–»ê²Œ í•˜ì‹œë‚˜ìš”?", options: ["ë‹¤ìŒë¶€í„´ ë¬¼ì–´ë³´ê³  ì“°ë¼ê³  ë§í•œë‹¤", "ê´œì°®ë‹¤ê³  í•˜ì§€ë§Œ ì†ìœ¼ë¡  ë¶ˆí¸í•˜ë‹¤", "í™”ê°€ ë‚˜ì„œ ë”°ì§€ë“¯ì´ ë§í•œë‹¤", "ë³„ë¡œ ì‹ ê²½ ì•ˆ ì“´ë‹¤"] },
            { question: "ì‹œí—˜ ì¼ì£¼ì¼ ì „ì¸ë° ì¬ë°ŒëŠ” ë“œë¼ë§ˆê°€ ìˆì–´ìš”.", options: ["ì‹œí—˜ ëë‚˜ê³  ëª°ì•„ë³¸ë‹¤", "í•˜ë£¨ 1í™”ì”©ë§Œ ë³¸ë‹¤", "ê³µë¶€í•˜ë‹¤ê°€ ì‰´ ë•Œ ë³¸ë‹¤", "ì¼ë‹¨ ëê¹Œì§€ ë³¸ë‹¤"] },
            { question: "ë‹¨ì²´ ì±„íŒ…ë°©ì—ì„œ ë‚˜ë§Œ ë‹µì¥ì„ ì•ˆ í–ˆì–´ìš”.", options: ["ëŠ¦ì—ˆì§€ë§Œ ë°”ë¡œ ë‹µì¥í•œë‹¤", "ë‚˜ì¤‘ì— ê°œì¸ì ìœ¼ë¡œ ë§í•œë‹¤", "ë‹¤ìŒ ëŒ€í™” ë•Œ ì°¸ì—¬í•œë‹¤", "ì•ˆ ë³¸ ì²™í•œë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ì•½ì†ì— 30ë¶„ ëŠ¦ì—ˆì–´ìš”.", options: ["ì™œ ëŠ¦ì—ˆëŠ”ì§€ ë¬¼ì–´ë³¸ë‹¤", "ë‹¤ìŒì—” ì‹œê°„ ì§€í‚¤ìê³  ë§í•œë‹¤", "ë³„ë§ ì—†ì´ ê¸°ë‹¤ë ¸ë‹¤ê³ ë§Œ í•œë‹¤", "ë‚˜ë„ ë‹¤ìŒì—” ëŠ¦ê²Œ ë‚˜ì˜¨ë‹¤"] },
            { question: "ì¡°ë³„ê³¼ì œ íšŒì˜ ì‹œê°„ì„ ì •í•´ì•¼ í•´ìš”.", options: ["ë‚´ê°€ ì‹œê°„í‘œ ê³µìœ í•˜ë©° ì œì•ˆí•œë‹¤", "ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ë§í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤", "íˆ¬í‘œë¡œ ì •í•˜ìê³  ì œì•ˆí•œë‹¤", "ë‹¤ìˆ˜ê°€ ë˜ëŠ” ì‹œê°„ì— ë§ì¶˜ë‹¤"] },
            { question: "ì‹ë‹¹ì—ì„œ ì£¼ë¬¸í•œ ìŒì‹ì´ ì˜ëª» ë‚˜ì™”ì–´ìš”.", options: ["ë°”ë¡œ ë§ì”€ë“œë ¤ì„œ ë°”ê¾¼ë‹¤", "ê´œì°®ì€ ë©”ë‰´ë©´ ê·¸ëƒ¥ ë¨¹ëŠ”ë‹¤", "ë¨¹ìœ¼ë©´ì„œ ë‹¤ìŒì—” í™•ì¸í•˜ì ìƒê°í•œë‹¤", "ë¶ˆí¸í•˜ì§€ë§Œ ê·¸ëƒ¥ ë¨¹ëŠ”ë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ê³ ë¯¼ìƒë‹´ì„ í•´ìš”.", options: ["í•´ê²°ì±…ì„ ì œì‹œí•œë‹¤", "ê³µê°í•˜ë©° ë“¤ì–´ì¤€ë‹¤", "ë¹„ìŠ·í•œ ë‚´ ê²½í—˜ì„ ë§í•´ì¤€ë‹¤", "ê¸ì •ì ìœ¼ë¡œ ê²©ë ¤í•œë‹¤"] },
            { question: "ê°‘ìê¸° ëª¨ë¥´ëŠ” ë²ˆí˜¸ì—ì„œ ì „í™”ê°€ ì™€ìš”.", options: ["ë°›ì•„ì„œ ëˆ„êµ°ì§€ í™•ì¸í•œë‹¤", "ê²€ìƒ‰í•´ë³´ê³  ë°›ì„ì§€ ê²°ì •í•œë‹¤", "ì¼ë‹¨ ì•ˆ ë°›ê³  ë¬¸ì ì˜¤ë©´ ë³¸ë‹¤", "ëª¨ë¥´ëŠ” ë²ˆí˜¸ëŠ” ì•ˆ ë°›ëŠ”ë‹¤"] },
            { question: "ê³¼ì œ ì œì¶œì¼ì´ ë‚´ì¼ì¸ë° ê±°ì˜ ì•ˆ í–ˆì–´ìš”.", options: ["ë°¤ìƒˆì„œë¼ë„ ëë‚¸ë‹¤", "í•  ìˆ˜ ìˆëŠ” ë§Œí¼ë§Œ í•œë‹¤", "êµìˆ˜ë‹˜ê»˜ ì—°ì¥ ìš”ì²­í•œë‹¤", "ì¹œêµ¬ì—ê²Œ ë„ì›€ì„ ì²­í•œë‹¤"] },
            { question: "ì¹œêµ¬ë“¤ì´ ë‚´ê°€ ëª¨ë¥´ëŠ” ì–˜ê¸°ë¥¼ í•´ìš”.", options: ["ë¬´ìŠ¨ ì–˜ê¸°ì¸ì§€ ë¬¼ì–´ë³¸ë‹¤", "ì›ƒìœ¼ë©´ì„œ ë“£ê³  ìˆëŠ”ë‹¤", "ë‹¤ë¥¸ ì£¼ì œë¡œ ë°”ê¾¼ë‹¤", "í•¸ë“œí°ì„ ë³¸ë‹¤"] },
            { question: "í¸ì˜ì ì—ì„œ ê³„ì‚°í•  ë•Œ ì¤„ì´ ê¸¸ì–´ìš”.", options: ["ê¸°ë‹¤ë¦¬ë©´ì„œ ì‚´ ê±° ë” ë‘˜ëŸ¬ë³¸ë‹¤", "ê·¸ëƒ¥ ì°¸ê³  ê¸°ë‹¤ë¦°ë‹¤", "ë‹¤ìŒì— ì‚¬ëŸ¬ ì˜¤ë ¤ê³  ë‚˜ê°„ë‹¤", "ë‹¤ë¥¸ í¸ì˜ì ì„ ì°¾ì•„ë³¸ë‹¤"] },
            { question: "SNSì—ì„œ ë‚´ê°€ ì˜¬ë¦° ê²Œì‹œë¬¼ì— ë°˜ì‘ì´ ì—†ì–´ìš”.", options: ["ë³„ë¡œ ì‹ ê²½ ì•ˆ ì“´ë‹¤", "ì¡°ê¸ˆ ì•„ì‰½ì§€ë§Œ ê´œì°®ë‹¤", "ë‹¤ìŒì—” ë” ì˜ ì˜¬ë ¤ì•¼ê² ë‹¤ê³  ìƒê°í•œë‹¤", "ì§€ìš°ê³  ë‹¤ì‹œ ì˜¬ë¦°ë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ë¹„ë°€ì„ ë§í•´ì£¼ì§€ ë§ë¼ê³  í–ˆëŠ”ë° ë‹¤ë¥¸ ì¹œêµ¬ê°€ ë¬¼ì–´ë´ìš”.", options: ["ë§ ëª» í•œë‹¤ê³  ì •í™•íˆ ë§í•œë‹¤", "ëŒ€ì¶© ì–¼ë²„ë¬´ë¦°ë‹¤", "ë‹¤ë¥¸ ì£¼ì œë¡œ ëŒë¦°ë‹¤", "ì‚´ì§ë§Œ íŒíŠ¸ë¥¼ ì¤€ë‹¤"] },
            { question: "ì¹´í˜ì—ì„œ ê³µë¶€í•˜ëŠ”ë° ì˜†ìë¦¬ê°€ ì‹œë„ëŸ¬ì›Œìš”.", options: ["ì¡°ìš©íˆ í•´ë‹¬ë¼ê³  ì •ì¤‘íˆ ë§í•œë‹¤", "ìë¦¬ë¥¼ ì˜®ê¸´ë‹¤", "ì´ì–´í°ì„ ë‚€ë‹¤", "ì°¸ê³  ì§‘ì¤‘í•œë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ë‚´ ì˜ê²¬ì— ë™ì˜í•˜ì§€ ì•Šì•„ìš”.", options: ["ì™œ ê·¸ë ‡ê²Œ ìƒê°í•˜ëŠ”ì§€ ë¬¼ì–´ë³¸ë‹¤", "ë‚´ ìƒê°ì„ ë” ì„¤ëª…í•œë‹¤", "ë™ì˜ëŠ” ì•ˆ í•˜ì§€ë§Œ ì¸ì •í•œë‹¤", "ë” ì´ìƒ ì–˜ê¸°í•˜ì§€ ì•ŠëŠ”ë‹¤"] },
            { question: "ìƒˆ í•™ê¸°ì— ëª¨ë¥´ëŠ” ì‚¬ëŒë“¤ê³¼ ê°™ì€ ì¡°ê°€ ëì–´ìš”.", options: ["ë¨¼ì € ì¸ì‚¬í•˜ê³  ë§ ê±´ë„¨ë‹¤", "ëˆ„ê°€ ë§ ê±¸ì–´ì£¼ê¸¸ ê¸°ë‹¤ë¦°ë‹¤", "ì›ƒìœ¼ë©´ì„œ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™” ì°¸ì—¬í•œë‹¤", "í•„ìš”í•  ë•Œë§Œ ì–˜ê¸°í•œë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ë‚´ SNS ê²Œì‹œë¬¼ì— ì´ìƒí•œ ëŒ“ê¸€ì„ ë‹¬ì•˜ì–´ìš”.", options: ["ì§ì ‘ ë¬¼ì–´ë³¸ë‹¤", "ì¥ë‚œìœ¼ë¡œ ë°›ì•„ë“¤ì¸ë‹¤", "ë¬´ì‹œí•œë‹¤", "ëŒ“ê¸€ì„ ì§€ìš´ë‹¤"] },
            { question: "ìˆ˜ì—… ì¤‘ì— ê¶ê¸ˆí•œ ê²Œ ìƒê²¼ì–´ìš”.", options: ["ë°”ë¡œ ì† ë“¤ê³  ì§ˆë¬¸í•œë‹¤", "ìˆ˜ì—… ëë‚˜ê³  ì§ˆë¬¸í•œë‹¤", "ì¹œêµ¬ì—ê²Œ ë¬¼ì–´ë³¸ë‹¤", "ë‚˜ì¤‘ì— í˜¼ì ì°¾ì•„ë³¸ë‹¤"] },
            { question: "ì•½ì† ì¥ì†Œë¥¼ ì •í•´ì•¼ í•˜ëŠ”ë° ì˜ê²¬ì´ ì•ˆ ëª¨ì—¬ìš”.", options: ["ì¤‘ê°„ ì§€ì ì„ ì œì•ˆí•œë‹¤", "íˆ¬í‘œë¥¼ ì œì•ˆí•œë‹¤", "ê°€ì¥ ë§ì€ ì‚¬ëŒì´ í¸í•œ ê³³ìœ¼ë¡œ í•œë‹¤", "ë‚´ê°€ ì–‘ë³´í•œë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ë‚´ ë¬¼ê±´ì„ ë¹Œë ¤ë‹¬ë¼ê³  í•´ìš”.", options: ["ì¡°ì‹¬íˆ ì“°ë¼ê³  í•˜ê³  ë¹Œë ¤ì¤€ë‹¤", "ì–¸ì œ ëŒë ¤ì¤„ì§€ í™•ì¸í•˜ê³  ë¹Œë ¤ì¤€ë‹¤", "ë¯¸ì•ˆí•˜ì§€ë§Œ ì•ˆ ë¹Œë ¤ì¤€ë‹¤ê³  í•œë‹¤", "ë‹¤ìŒì— ë¹Œë ¤ì£¼ê² ë‹¤ê³  í•œë‹¤"] },
            { question: "ë°¤ëŠ¦ê²Œê¹Œì§€ ê²Œì„í•˜ë‹¤ê°€ ë‹¤ìŒë‚  ì•„ì¹¨ì— ì¼ì–´ë‚˜ê¸° í˜ë“¤ì–´ìš”.", options: ["ì•ŒëŒ ì—¬ëŸ¬ ê°œ ë§ì¶°ë†“ëŠ”ë‹¤", "ê²Œì„ ì‹œê°„ì„ ì¤„ì¸ë‹¤", "ê·¸ëƒ¥ í”¼ê³¤í•˜ì§€ë§Œ ì¼ì–´ë‚œë‹¤", "ì¢€ ë” ìê³  ëŠ¦ê²Œ ì¼ì–´ë‚œë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ë‚´ ì•½ì ì„ ë†ë‹´ìœ¼ë¡œ ë§í–ˆì–´ìš”.", options: ["ì›ƒìœ¼ë©´ì„œ ë°›ì•„ì¹˜ì§€ë§Œ ì†ìƒí•˜ë‹¤", "ì§„ì§€í•˜ê²Œ ë¶ˆí¸í•˜ë‹¤ê³  ë§í•œë‹¤", "ê°™ì´ ì›ƒëŠ”ë‹¤", "ë§ì—†ì´ í‘œì •ì´ êµ³ëŠ”ë‹¤"] },
            { question: "ê¸¸ì—ì„œ ì§€ê°‘ì„ ì£¼ì› ì–´ìš”.", options: ["ë°”ë¡œ ê²½ì°°ì„œì— ê°€ì ¸ê°„ë‹¤", "ì£¼ë³€ ì‚¬ëŒì—ê²Œ ë¬¼ì–´ë³¸ë‹¤", "ì£¼ì¸ ì—°ë½ì²˜ ì°¾ì•„ì„œ ì—°ë½í•œë‹¤", "ê·¼ì²˜ ê°€ê²Œì— ë§¡ê¸´ë‹¤"] },
            { question: "ê·¸ë£¹ ê³¼ì œì—ì„œ ë‚´ ì˜ê²¬ì´ ì±„íƒë˜ì§€ ì•Šì•˜ì–´ìš”.", options: ["ë‹¤ë¥¸ ì˜ê²¬ë„ ì¢‹ë‹¤ê³  ì¸ì •í•œë‹¤", "ì™œ ë‚´ ì˜ê²¬ì´ ì•ˆ ì¢‹ì€ì§€ ë¬¼ì–´ë³¸ë‹¤", "ì¡°ìš©íˆ ì•„ì‰¬ì›Œí•œë‹¤", "ë‹¤ìŒì—” ë” ì„¤ë“ë ¥ìˆê²Œ ë§í•´ì•¼ê² ë‹¤ê³  ìƒê°í•œë‹¤"] },
            { question: "ë°°ë‹¬ ìŒì‹ì´ ëŠ¦ê²Œ ì™€ìš”.", options: ["ì „í™”í•´ì„œ í™•ì¸í•œë‹¤", "ì¡°ê¸ˆ ë” ê¸°ë‹¤ë¦°ë‹¤", "ë‹¤ë¥¸ ê±° ì‹œì¼œë¨¹ëŠ”ë‹¤", "ì°¸ê³  ê¸°ë‹¤ë¦¬ë©´ì„œ ë°°ê³ í””ì„ ì°¸ëŠ”ë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ë‚´ ë¹„ë°€ì„ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë§í–ˆì–´ìš”.", options: ["í™”ë‚´ë©° ë”°ì§„ë‹¤", "ì‹¤ë§í–ˆë‹¤ê³  ë§í•œë‹¤", "ê±°ë¦¬ë¥¼ ë‘”ë‹¤", "ê·¸ëƒ¥ ë„˜ì–´ê°„ë‹¤"] },
            { question: "ì‹œí—˜ ì „ë‚  ì¹œêµ¬ê°€ ë†€ìê³  í•´ìš”.", options: ["ë¯¸ì•ˆí•˜ì§€ë§Œ ê±°ì ˆí•œë‹¤", "ì ê¹ë§Œ ë³´ìê³  í•œë‹¤", "ì‹œí—˜ ëë‚˜ê³  ë³´ìê³  í•œë‹¤", "ê·¸ëƒ¥ ë§Œë‚œë‹¤"] },
            { question: "ì¸í„°ë„·ì—ì„œ ë‚´ ì˜ê²¬ê³¼ ë‹¤ë¥¸ ëŒ“ê¸€ì„ ë´¤ì–´ìš”.", options: ["ë‚´ ìƒê°ì„ ëŒ“ê¸€ë¡œ ë‚¨ê¸´ë‹¤", "ê·¸ëƒ¥ ë„˜ì–´ê°„ë‹¤", "ì™œ ê·¸ë ‡ê²Œ ìƒê°í•˜ëŠ”ì§€ ê¶ê¸ˆí•˜ë‹¤", "ì§œì¦ë‚˜ì§€ë§Œ ë¬´ì‹œí•œë‹¤"] },
            { question: "ë²„ìŠ¤ì—ì„œ í• ë¨¸ë‹ˆê°€ ì„œ ê³„ì„¸ìš”.", options: ["ë°”ë¡œ ìë¦¬ë¥¼ ì–‘ë³´í•œë‹¤", "ì£¼ë³€ì„ ë³´ê³  ë‹¤ë¥¸ ì‚¬ëŒë„ ì•ˆ ì¼ì–´ë‚˜ë©´ ì¼ì–´ë‚œë‹¤", "í”¼ê³¤í•´ì„œ ì ê¹ ë” ì•‰ì•„ìˆë‹¤ê°€ ë‚´ë¦¬ê¸° ì „ì— ì–‘ë³´í•œë‹¤", "ìëŠ” ì²™í•œë‹¤"] },
            { question: "ì¹œêµ¬ ìƒì¼ì¸ë° ì„ ë¬¼ì„ ì¤€ë¹„ ëª»í–ˆì–´ìš”.", options: ["ê¸‰í•˜ê²Œë¼ë„ ì‚¬ëŸ¬ ê°„ë‹¤", "ì†”ì§í•˜ê²Œ ë§í•˜ê³  ë‹¤ìŒì— ì‚¬ì¤€ë‹¤ê³  í•œë‹¤", "ë°¥ì„ ì‚¬ì¤€ë‹¤", "ì¶•í•˜ ë©”ì‹œì§€ë§Œ ë³´ë‚¸ë‹¤"] },
            { question: "ìˆ˜ì—… ì‹œê°„ì— ì„ ìƒë‹˜ì´ í‹€ë¦° ë§ì”€ì„ í•˜ì…¨ì–´ìš”.", options: ["ì†ë“¤ê³  ì •ì¤‘íˆ ì§ˆë¬¸í•œë‹¤", "ìˆ˜ì—… ëë‚˜ê³  ë§ì”€ë“œë¦°ë‹¤", "ì¹œêµ¬ë“¤ì—ê²Œë§Œ ë§í•œë‹¤", "ê·¸ëƒ¥ ë„˜ì–´ê°„ë‹¤"] },
            { question: "ë‹¨ì²´ ì±„íŒ…ì—ì„œ ë‚˜ì— ëŒ€í•œ ì•ˆ ì¢‹ì€ ì–˜ê¸°ê°€ ì˜¬ë¼ì™”ì–´ìš”.", options: ["ë°”ë¡œ í•´ëª…í•œë‹¤", "ê°œì¸ì ìœ¼ë¡œ ë”°ë¡œ ì–˜ê¸°í•œë‹¤", "ë¬´ì‹œí•œë‹¤", "ì±„íŒ…ë°©ì„ ë‚˜ê°„ë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ëˆì„ ë¹Œë ¤ë‹¬ë¼ê³  í•´ìš”.", options: ["ì–¸ì œ ê°šì„ì§€ í™•ì¸í•˜ê³  ë¹Œë ¤ì¤€ë‹¤", "ë¹Œë ¤ì¤„ ìˆ˜ ì—†ë‹¤ê³  ì •ì¤‘íˆ ê±°ì ˆí•œë‹¤", "ë‹¤ë¥¸ ë°©ë²•ì„ ì œì•ˆí•œë‹¤", "ì ì€ ê¸ˆì•¡ë§Œ ë¹Œë ¤ì¤€ë‹¤"] },
            { question: "ì¢‹ì•„í•˜ëŠ” ì—°ì˜ˆì¸ì´ ë…¼ë€ì— íœ©ì‹¸ì˜€ì–´ìš”.", options: ["ì‚¬ì‹¤ í™•ì¸ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦°ë‹¤", "íŒ¬ì´ì§€ë§Œ ì˜ëª»ì€ ì˜ëª»ì´ë¼ê³  ìƒê°í•œë‹¤", "ë¬´ì¡°ê±´ í¸ì„ ë“ ë‹¤", "ê´€ì‹¬ì„ ëŠëŠ”ë‹¤"] },
            { question: "í•™êµì—ì„œ ë‚´ ë¬¼ê±´ì´ ì—†ì–´ì¡Œì–´ìš”.", options: ["ì„ ìƒë‹˜ê»˜ ë§ì”€ë“œë¦°ë‹¤", "ì¹œêµ¬ë“¤ì—ê²Œ ë¬¼ì–´ë³¸ë‹¤", "í˜¼ì ì°¾ì•„ë³¸ë‹¤", "ê·¸ëƒ¥ í¬ê¸°í•œë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ì‹œí—˜ ë‹µì„ ë³´ì—¬ë‹¬ë¼ê³  í•´ìš”.", options: ["ë‹¨í˜¸í•˜ê²Œ ê±°ì ˆí•œë‹¤", "ë‚˜ì¤‘ì— ê°™ì´ ê³µë¶€í•˜ìê³  í•œë‹¤", "ë‚œì²˜í•´í•˜ë©° ê±°ì ˆí•œë‹¤", "ì‚´ì§ ë³´ì—¬ì¤€ë‹¤"] },
            { question: "ì¢‹ì•„í•˜ëŠ” ì‚¬ëŒì´ ë‚´ ì¹œêµ¬ë¥¼ ì¢‹ì•„í•˜ëŠ” ê²ƒ ê°™ì•„ìš”.", options: ["ì¹œêµ¬ì—ê²Œ ì†”ì§í•˜ê²Œ ë§í•œë‹¤", "í˜¼ì ì†ìƒí•´í•œë‹¤", "í¬ê¸°í•œë‹¤", "ë” ì—´ì‹¬íˆ ì–´í•„í•œë‹¤"] },
            { question: "ë‹¨ì²´ ì‚¬ì§„ì—ì„œ ë‚´ê°€ ì´ìƒí•˜ê²Œ ë‚˜ì™”ì–´ìš”.", options: ["ë‹¤ì‹œ ì°ìê³  í•œë‹¤", "ê·¸ëƒ¥ ì˜¬ë¦°ë‹¤", "ë‚´ê°€ ë‚˜ì˜¨ ë¶€ë¶„ì„ ê°€ë ¤ë‹¬ë¼ê³  í•œë‹¤", "ë‚´ê°€ ì•ˆ ë‚˜ì˜¨ ì‚¬ì§„ë§Œ ì˜¬ë ¤ë‹¬ë¼ê³  í•œë‹¤"] },
            { question: "ì¹œêµ¬ê°€ ë‚´ ê³ ë¯¼ì„ ì§„ì§€í•˜ê²Œ ì•ˆ ë“¤ì–´ì¤˜ìš”.", options: ["ì§„ì§€í•˜ê²Œ ë“¤ì–´ë‹¬ë¼ê³  ë§í•œë‹¤", "ë‹¤ë¥¸ ì¹œêµ¬ì—ê²Œ ë§í•œë‹¤", "í˜¼ì í•´ê²°í•œë‹¤", "ì„œìš´í•˜ì§€ë§Œ ê·¸ëƒ¥ ë„˜ì–´ê°„ë‹¤"] },
            { question: "ê¸¸ì—ì„œ ë„˜ì–´ì§„ ì‚¬ëŒì„ ë´¤ì–´ìš”.", options: ["ë°”ë¡œ ë‹¬ë ¤ê°€ì„œ ì¼ìœ¼ì¼œì¤€ë‹¤", "ê´œì°®ì€ì§€ ë¬¼ì–´ë³¸ë‹¤", "ì£¼ë³€ì„ ë³´ë‹¤ê°€ ì•„ë¬´ë„ ì•ˆ ë„ì™€ì£¼ë©´ ë•ëŠ”ë‹¤", "ì§€ë‚˜ê°„ë‹¤"] }
        ];

        // ì „ì—­ ìƒíƒœ ë° íƒ€ì„ì•„ì›ƒ ID
        let reactionTimeout = null;
        let timingAnimationId = null;
        let rhythmGameInterval = null;
        let rhythmNoteGenerator = null;

        let state = {
            stage: 'welcome',
            questionCount: 7,
            selectedQuestions: [],
            currentQuestion: 0,
            answers: [],
            answerTimes: [],
            questionStartTime: 0,
            miniGameScores: [],
            currentMiniGame: 'reaction',
            // ê²Œì„ë³„ ìƒíƒœ
            reactionStage: 'waiting',
            reactionStartTime: 0,
            reactionTime: 0,
            timingPosition: 0,
            timingDirection: 1,
            timingStopped: false,
            timingResult: null,
            rhythmNotes: [],
            rhythmScore: 0,
            rhythmCombo: 0,
            rhythmGameTime: 0,
            rhythmFeedback: ''
        };

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function getRandomQuestions(count) {
            const shuffled = [...questionPool].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, count);
        }

        // ë¬¸ì œ ê°œìˆ˜ì— ë”°ë¥¸ ë¯¸ë‹ˆê²Œì„ ì‚½ì… ìœ„ì¹˜ ê²°ì • (0ë¶€í„° ì‹œì‘í•˜ëŠ” ì¸ë±ìŠ¤)
        function getMiniGamePositions(count) {
            if (count === 5) return [1, 3]; // 2ë²ˆì§¸, 4ë²ˆì§¸ ì§ˆë¬¸ í›„
            if (count === 7) return [1, 3, 5]; // 2ë²ˆì§¸, 4ë²ˆì§¸, 6ë²ˆì§¸ ì§ˆë¬¸ í›„
            if (count === 10) return [2, 5, 8]; // 3ë²ˆì§¸, 6ë²ˆì§¸, 9ë²ˆì§¸ ì§ˆë¬¸ í›„
            return [];
        }

        // ê²°ê³¼ ë¶„ì„ (ë‹¨ìˆœ ì˜ˆì‹œ)
        function getComprehensiveResult() {
            // 1. íŒë‹¨ ì†ë„ (ì§ˆë¬¸ ì‘ë‹µ ì‹œê°„) - 30ì  ë§Œì 
            const totalAnswerTime = state.answerTimes.reduce((a, b) => a + b, 0);
            const avgTime = totalAnswerTime / state.answerTimes.length;
            let speedScore = 0;
            // 3000ms ì´í•˜: 30ì , 5000ms ì´í•˜: 20ì , 7000ms ì´í•˜: 10ì , ê·¸ ì´ìƒ: 5ì 
            if (avgTime < 3000) speedScore = 30;
            else if (avgTime < 5000) speedScore = 20;
            else if (avgTime < 7000) speedScore = 10;
            else speedScore = 5;

            // 2. ë¯¸ë‹ˆê²Œì„ ì‹¤ë ¥ - 50ì  ë§Œì  (ê° ê²Œì„ë‹¹ 16ì , 17ì , 17ì )
            let gameScore = 0;
            let reactionMs = 0;
            let timingDiff = 0;
            let rhythmPts = 0;

            const reactionScoreData = state.miniGameScores.find(s => s.type === 'reaction');
            const timingScoreData = state.miniGameScores.find(s => s.type === 'timing');
            const rhythmScoreData = state.miniGameScores.find(s => s.type === 'rhythm');
            
            if (reactionScoreData) {
                reactionMs = reactionScoreData.score;
                // ë°˜ì‘ì†ë„ ì ìˆ˜ (16ì  ë§Œì )
                if (reactionMs < 300) gameScore += 16;
                else if (reactionMs < 400) gameScore += 12;
                else if (reactionMs < 500) gameScore += 8;
                else gameScore += 4;
            }

            if (timingScoreData) {
                timingDiff = timingScoreData.score;
                // íƒ€ì´ë° ì ìˆ˜ (17ì  ë§Œì )
                if (timingDiff < 5) gameScore += 17;
                else if (timingDiff < 10) gameScore += 13;
                else if (timingDiff < 20) gameScore += 8;
                else gameScore += 4;
            }
            
            if (rhythmScoreData) {
                rhythmPts = rhythmScoreData.score;
                // ë¦¬ë“¬ ì ìˆ˜ (17ì  ë§Œì , ìµœëŒ€ 100ì ë‹¹ 17ì )
                gameScore += Math.min(17, Math.floor(rhythmPts / 6)); 
            }

            // 3. ë‹µë³€ ì¼ê´€ì„±/ì„±í–¥ - 20ì  ë§Œì 
            // (ì˜ˆì‹œ: A/Bë¥¼ ë§ì´ ì„ íƒí•˜ë©´ ì ê·¹/ê³„íšì , C/Dë¥¼ ë§ì´ ì„ íƒí•˜ë©´ ì†Œê·¹/ìˆœì‘ì ìœ¼ë¡œ ê°„ì£¼)
            let aCount = 0;
            let bCount = 0;
            let cCount = 0;
            let dCount = 0;
            state.answers.forEach(a => {
                const q = questionPool.find(p => p.question === a.question);
                const index = q.options.indexOf(a.answer);
                if (index === 0) aCount++;
                else if (index === 1) bCount++;
                else if (index === 2) cCount++;
                else if (index === 3) dCount++;
            });

            // A/Bê°€ ë§ìœ¼ë©´ ì¼ê´€ì„±ì´ ë†’ë‹¤ê³  ê°€ì • (20ì  ë§Œì )
            let consistencyScore = Math.floor(((aCount + bCount) / state.answers.length) * 20); 
            
            const totalScore = speedScore + gameScore + consistencyScore;

            // ê²°ê³¼ ìœ í˜• ë¶„ë¥˜ (ë§¤ìš° ë‹¨ìˆœí™”ëœ ë¡œì§)
            let resultType, resultDescription, resultDetail, resultEmoji;

            if (totalScore >= 80) {
                resultType = "ë²ˆê°œê°™ì´ ë¹ ë¥¸ ê²°ì •ê°€ ğŸ‘‘";
                resultEmoji = "âš¡";
                resultDescription = "ì‹ ì†í•œ íŒë‹¨ë ¥ê³¼ ë›°ì–´ë‚œ ì‹¤í–‰ë ¥ì„ ê²¸ë¹„í•œ ë¦¬ë” ìœ í˜•ì…ë‹ˆë‹¤.";
                resultDetail = `ë‹¹ì‹ ì€ ìƒí™© íŒë‹¨ì´ ë§¤ìš° ë¹ ë¥´ê³ , í–‰ë™ì— ë§ì„¤ì„ì´ ì—†ìŠµë‹ˆë‹¤. (${Math.floor(avgTime)}ms) ë¯¸ë‹ˆê²Œì„ì—ì„œë„ ë›°ì–´ë‚œ ê°ê°ì„ ë³´ì—¬ì£¼ì–´ ìœ„ê¸° ìƒí™© ëŒ€ì²˜ ëŠ¥ë ¥ì´ íƒì›”í•©ë‹ˆë‹¤. ë‹¤ë§Œ, ë•Œë¡œëŠ” ë¹ ë¥¸ ê²°ì •ì´ ì„±ê¸‰í•¨ìœ¼ë¡œ ì´ì–´ì§€ì§€ ì•Šë„ë¡ ì£¼ë³€ ì˜ê²¬ì„ ìˆ˜ë ´í•˜ëŠ” ë…¸ë ¥ë„ í•„ìš”í•©ë‹ˆë‹¤.`;
            } else if (totalScore >= 60) {
                resultType = "ì‹ ì¤‘í•œ ì™„ë²½ì£¼ì˜ì ğŸ’¡";
                resultEmoji = "ğŸ§";
                resultDescription = "ê³„íšì ì´ê³  ì¹¨ì°©í•˜ë©°, ë†’ì€ ì™„ì„±ë„ë¥¼ ì¶”êµ¬í•˜ëŠ” íƒ€ì…ì…ë‹ˆë‹¤.";
                resultDetail = `ì§ˆë¬¸ì— ëŒ€í•´ ì¶©ë¶„íˆ ê³ ë ¤í•˜ì—¬ í•©ë¦¬ì ì¸ ì„ íƒì„ í•˜ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤. ë¯¸ë‹ˆê²Œì„ ì‹¤ë ¥ë„ ì¤€ìˆ˜í•˜ë©°, íŠ¹íˆ ì¼ê´€ì„± ìˆëŠ” í–‰ë™ ì–‘ì‹ìœ¼ë¡œ ì‹ ë¢°ë¥¼ ì–»ìŠµë‹ˆë‹¤. í–‰ë™ ì „ì— ê¹Šì´ ìƒê°í•˜ê¸° ë•Œë¬¸ì— í‰ê·  ë‹µë³€ ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆì§€ë§Œ, ê·¸ë§Œí¼ ì‹¤ìˆ˜ê°€ ì ìŠµë‹ˆë‹¤.`;
            } else if (totalScore >= 40) {
                resultType = "ìƒí™©ì— ìœ ì—°í•œ ì¡°ìœ¨ê°€ âš–ï¸";
                resultEmoji = "ğŸ¤";
                resultDescription = "ê°ˆë“±ì„ íšŒí”¼í•˜ê³  ì£¼ë³€ì— ë§ì¶”ëŠ” ì¹œí™”ì ì¸ ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤.";
                resultDetail = `ë‹¹ì‹ ì€ íƒ€ì¸ì˜ ì˜ê²¬ì„ ì˜ ìˆ˜ìš©í•˜ë©°, ëŒ€ì¸ê´€ê³„ì—ì„œ í° ë§ˆì°°ì„ ë§Œë“¤ì§€ ì•ŠëŠ” ìœ ì—°í•¨ì„ ë³´ì…ë‹ˆë‹¤. íŒë‹¨ ì†ë„ëŠ” í‰ê· ì ì´ë©°, ë¯¸ë‹ˆê²Œì„ì—ì„œëŠ” ì§‘ì¤‘ë ¥ì— ë”°ë¼ ê¸°ë³µì„ ë³´ì˜€ìŠµë‹ˆë‹¤. ìì‹ ì˜ ì˜ê²¬ì„ ëª…í™•íˆ í‘œí˜„í•˜ëŠ” ì—°ìŠµì„ í•œë‹¤ë©´ ë”ìš± ë°œì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            } else {
                resultType = "ëŠê¸‹í•œ ììœ ì˜í˜¼ ğŸˆ";
                resultEmoji = "ğŸŒ";
                resultDescription = "ê²°ê³¼ì— ì–½ë§¤ì´ì§€ ì•Šê³  ëŠê¸‹í•˜ê²Œ ì‚¶ì„ ì¦ê¸°ëŠ” íƒ€ì…ì…ë‹ˆë‹¤.";
                resultDetail = `ì£¼ì–´ì§„ ë¬¸ì œì— í¬ê²Œ ìŠ¤íŠ¸ë ˆìŠ¤ ë°›ì§€ ì•Šìœ¼ë©°, ë‹µë³€ ì‹œê°„ì´ ë¹„êµì  ê¸´ í¸ì…ë‹ˆë‹¤. ì´ëŠ” ëª¨ë“  ì˜µì…˜ì„ ì—¬ìœ ë¡­ê²Œ ê³ ë ¤í•˜ê±°ë‚˜, í˜¹ì€ ê¹Šê²Œ ìƒê°í•˜ì§€ ì•ŠìŒì„ ì˜ë¯¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸‰ë°•í•œ ìƒí™©ë³´ë‹¤ëŠ” ììœ ë¡œìš´ í™˜ê²½ì—ì„œ ìµœê³ ì˜ ëŠ¥ë ¥ì„ ë°œíœ˜í•©ë‹ˆë‹¤.`;
            }


            return { totalScore, speedScore, gameScore, consistencyScore, reactionMs, timingDiff, rhythmPts, resultType, resultDescription, resultDetail, resultEmoji };
        }

        // ë Œë”ë§ í•¨ìˆ˜ë“¤
        function render() {
            const app = document.getElementById('app');
            
            if (state.stage === 'welcome') {
                app.innerHTML = renderWelcome();
            } else if (state.stage === 'questions') {
                app.innerHTML = renderQuestion();
                state.questionStartTime = Date.now(); // ì§ˆë¬¸ ì‹œì‘ ì‹œê°„ ê¸°ë¡
            } else if (state.stage === 'minigame') {
                if (state.currentMiniGame === 'reaction') {
                    app.innerHTML = renderReactionGame();
                    startReactionGame();
                } else if (state.currentMiniGame === 'timing') {
                    app.innerHTML = renderTimingGame();
                    startTimingGame();
                } else if (state.currentMiniGame === 'rhythm') {
                    app.innerHTML = renderRhythmGame();
                    startRhythmGame();
                }
            } else if (state.stage === 'result') {
                app.innerHTML = renderResult();
            }
        }

        function renderWelcome() {
            return `
                <div class="icon-circle">â“</div>
                <h1>ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì£¼ì„¸ìš”</h1>
                <p class="subtitle">
                    ëª‡ ê°€ì§€ ì§ˆë¬¸ì— ë‹µí•˜ì‹œë©´ ë§ì¶¤í˜• ê²°ê³¼ë¥¼ ì œê³µí•´ë“œë¦½ë‹ˆë‹¤.<br>
                    ì†”ì§í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”! (ì§ˆë¬¸ ì¤‘ê°„ì— ë¯¸ë‹ˆê²Œì„ì´ í¬í•¨ë©ë‹ˆë‹¤)
                </p>
                <p style="text-align: center; font-size: 1.125rem; font-weight: 600; margin-bottom: 1.5rem;">ë¬¸ì œ ê°œìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                <div class="btn-group">
                    <button class="btn" onclick="handleStart(5)">
                        <span class="btn-number">5ë¬¸ì œ</span>
                        <span class="btn-text">ë¹ ë¥´ê²Œ</span>
                        <span class="btn-time">ë¯¸ë‹ˆê²Œì„ 2íšŒ í¬í•¨</span>
                    </button>
                    <button class="btn" onclick="handleStart(7)">
                        <span class="btn-number">7ë¬¸ì œ</span>
                        <span class="btn-text">ì ë‹¹í•˜ê²Œ</span>
                        <span class="btn-time">ë¯¸ë‹ˆê²Œì„ 3íšŒ í¬í•¨</span>
                    </button>
                    <button class="btn" onclick="handleStart(10)">
                        <span class="btn-number">10ë¬¸ì œ</span>
                        <span class="btn-text">ê¹Šì´ìˆê²Œ</span>
                        <span class="btn-time">ë¯¸ë‹ˆê²Œì„ 3íšŒ í¬í•¨</span>
                    </button>
                </div>
            `;
        }

        function renderQuestion() {
            const q = state.selectedQuestions[state.currentQuestion];
            // ì§ˆë¬¸ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆë‹¤ë©´ ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ (ë°©ì–´ ì½”ë“œ)
            if (!q) {
                state.stage = 'result';
                return '';
            }
            const progress = ((state.currentQuestion + 1) / state.selectedQuestions.length) * 100;
            
            return `
                <div class="progress-text">
                    <span>ì§ˆë¬¸ ${state.currentQuestion + 1}</span>
                    <span>${state.selectedQuestions.length}ê°œ ì¤‘</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                <div class="card">
                    <h2 class="question-title">${q.question}</h2>
                    <div class="options">
                        ${q.options.map((opt, idx) => `
                            <button class="option-btn" onclick="handleAnswer('${opt.replace(/'/g, "\\'")}')">
                                <span class="option-letter">${String.fromCharCode(65 + idx)}</span>
                                <span>${opt}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderReactionGame() {
            let className = 'game-waiting';
            let text = 'í´ë¦­í•´ì„œ ì‹œì‘í•˜ì„¸ìš”!';
            
            if (state.reactionStage === 'ready') {
                className = 'game-ready';
                text = 'ì¤€ë¹„... (ì ì‹œ ê¸°ë‹¤ë¦¬ì„¸ìš”)';
            } else if (state.reactionStage === 'go') {
                className = 'game-go';
                text = 'ì§€ê¸ˆ í´ë¦­!';
            } else if (state.reactionStage === 'tooEarly') {
                className = 'game-early';
                text = 'ë„ˆë¬´ ë¹¨ëì–´ìš”! ğŸ˜…';
            } else if (state.reactionStage === 'result') {
                className = 'game-result';
                text = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">âš¡</div>
                        <div style="font-size: 2rem;">${state.reactionTime}ms</div>
                        <div style="font-size: 1.25rem; margin-top: 0.5rem; color: #64748b;">
                            ${state.reactionTime === 0 ? 'ì‹¤íŒ¨ (ë„ˆë¬´ ë¹¨ëìŒ)' : state.reactionTime < 300 ? 'ì—„ì²­ ë¹ ë¥´ë„¤ìš”! ğŸ†' : state.reactionTime < 500 ? 'ì¢‹ì•„ìš”! ğŸ‘' : 'ê´œì°®ì•„ìš”! ğŸ˜Š'}
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="card">
                    <h2 style="text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">ë°˜ì‘ì†ë„ ê²Œì„</h2>
                    <p style="text-align: center; font-size: 0.875rem; color: #64748b; margin-bottom: 2rem;">
                        í™”ë©´ì´ ì´ˆë¡ìƒ‰ì´ ë˜ë©´ ìµœëŒ€í•œ ë¹¨ë¦¬ í´ë¦­í•˜ì„¸ìš”!
                    </p>
                    <div id="reaction-game-area" class="game-area ${className}">
                        ${text}
                    </div>
                </div>
            `;
        }

        function renderTimingGame() {
            let resultText = '';
            if (state.timingResult !== null) {
                const absDiff = Math.abs(state.timingResult);
                resultText = `
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ¯</div>
                        <div style="font-size: 2rem;">ì˜¤ì°¨: ${absDiff}px</div>
                        <div style="font-size: 1.25rem; margin-top: 0.5rem; color: #64748b;">
                            ${absDiff < 5 ? 'PERFECT! ğŸ’¯' : absDiff < 15 ? 'GREAT! ğŸ‘' : 'GOOD! ğŸ˜Š'}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="card">
                    <h2 style="text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">íƒ€ì´ë° ê²Œì„</h2>
                    <p style="text-align: center; font-size: 0.875rem; color: #64748b; margin-bottom: 2rem;">
                        ë§‰ëŒ€ê°€ ì¤‘ì•™ì— ì˜¬ ë•Œ ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!
                    </p>
                    <div class="game-timing game-area" id="timing-game" style="font-size: 1.5rem;">
                        <div class="target-zone"></div>
                        <div class="target-line"></div>
                        <div class="timing-bar" id="timing-bar" style="transform: translateX(${state.timingPosition}%)"></div>
                        ${state.timingResult !== null ? resultText : '<span style="color:#0c4a6e;">ì§‘ì¤‘!</span>'}
                    </div>
                    ${state.timingResult === null ? `
                        <div style="text-align: center; margin-top: 1.5rem;">
                            <button class="btn action-btn-primary" onclick="handleTimingStop()">ë©ˆì¶”ê¸° (ìŠ¤í˜ì´ìŠ¤ë°”)</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderRhythmGame() {
            const progress = (state.rhythmGameTime / 10000) * 100;
            const remainingTime = Math.max(0, Math.ceil((10000 - state.rhythmGameTime) / 1000));
            
            const noteElements = state.rhythmNotes.map(note => {
                const topPercentage = (note.time - state.rhythmGameTime) / 1000 * 90 + 5; // 1ì´ˆ ì „ ë…¸íŠ¸ëŠ” ìƒë‹¨ì— ìœ„ì¹˜
                const noteClass = note.hitStatus === 'hit' ? 'hit' : '';
                return `<div class="rhythm-note ${noteClass}" style="top: ${topPercentage}%;" data-note-id="${note.id}"></div>`;
            }).join('');
            
            return `
                <div class="card">
                    <div class="game-info">
                        <div>
                            <h2 style="font-size: 1.5rem; font-weight: bold;">ë¦¬ë“¬ ê²Œì„</h2>
                            <p style="font-size: 0.875rem; color: #64748b;">
                                ë…¸íŠ¸ê°€ ë¼ì¸ì— ë‹¿ì„ ë•Œ ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆ„ë¥´ì„¸ìš”! (ì´ 10ì´ˆ)
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <div class="game-score">${state.rhythmScore}</div>
                            <div style="font-size: 0.875rem; color: #64748b;">ì ìˆ˜</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                        <div style="flex: 1; height: 0.5rem; background: #e2e8f0; border-radius: 1rem; overflow: hidden;">
                            <div style="height: 100%; background: linear-gradient(90deg, #0891b2 0%, #67e8f9 100%); width: ${progress}%; transition: width 0.05s linear;"></div>
                        </div>
                        <div class="game-timer">${remainingTime}ì´ˆ</div>
                    </div>
                    ${state.rhythmCombo > 1 ? `<div class="game-combo">${state.rhythmCombo} Combo!</div>` : ''}
                    <div class="game-rhythm game-area" id="rhythm-game">
                        <div class="rhythm-target-zone"></div>
                        <div class="rhythm-target-line"></div>
                        ${noteElements}
                        ${state.rhythmFeedback ? `<div class="feedback-overlay"><div class="feedback-text feedback-${state.rhythmFeedback.toLowerCase()}">${state.rhythmFeedback}</div></div>` : ''}
                    </div>
                    <p class="game-instruction">í‚¤ë³´ë“œì˜ **ìŠ¤í˜ì´ìŠ¤ë°”**ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”</p>
                </div>
            `;
        }

        function renderResult() {
            const result = getComprehensiveResult();
            const minigameNames = { reaction: 'ë°˜ì‘ ì†ë„', timing: 'íƒ€ì´ë° ì •í™•ë„', rhythm: 'ë¦¬ë“¬ ê°ê°' };
            
            return `
                <div class="icon-circle" style="background: linear-gradient(135deg, #0891b2 0%, #67e8f9 100%);">âœ¨</div>
                <h1>ë¶„ì„ ê²°ê³¼ê°€ ë‚˜ì™”ìŠµë‹ˆë‹¤!</h1>
                <p class="subtitle">ë‹¹ì‹ ì˜ ë‹µë³€ê³¼ ë¯¸ë‹ˆê²Œì„ì„ ì¢…í•©ì ìœ¼ë¡œ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.</p>
                
                <div class="card">
                    <div class="result-type">
                        <div class="result-emoji">${result.resultEmoji}</div>
                        <div class="result-badge">ë‹¹ì‹ ì˜ ìœ í˜•</div>
                        <h2 class="result-title">${result.resultType}</h2>
                        <p class="result-description">${result.resultDescription}</p>
                        <div class="result-score-box">
                            <div class="result-score-label">ì¢…í•© ì ìˆ˜</div>
                            <div class="result-score-value">${result.totalScore}</div>
                            <div class="result-score-max">/ 100ì </div>
                        </div>
                    </div>
                    
                    <div class="result-detail-box">
                        <h3 class="result-detail-title">
                            <span style="width: 0.25rem; height: 1rem; background: #0891b2; border-radius: 9999px;"></span>
                            ì„¸ë¶€ ë¶„ì„
                        </h3>
                        <p class="result-detail-text">${result.resultDetail}</p>
                    </div>
                    
                    <div class="score-breakdown">
                        <h3 class="section-title">ì„¸ë¶€ ì ìˆ˜ ë¶„ì„</h3>
                        <div class="score-item">
                            <div class="score-item-label">
                                <span style="font-size: 1.5rem;">âš¡</span>
                                <span>íŒë‹¨ ì†ë„ (í‰ê·  ì‘ë‹µ ì‹œê°„: ${Math.floor(result.reactionMs || 0)}ms)</span>
                            </div>
                            <div class="score-item-value">${result.speedScore}/30</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-label">
                                <span style="font-size: 1.5rem;">ğŸ¯</span>
                                <span>ë‹µë³€ ì¼ê´€ì„±/ì„±í–¥</span>
                            </div>
                            <div class="score-item-value">${result.consistencyScore}/20</div>
                        </div>
                        <div class="score-item">
                            <div class="score-item-label">
                                <span style="font-size: 1.5rem;">ğŸ®</span>
                                <span>ë¯¸ë‹ˆê²Œì„ ì‹¤ë ¥</span>
                            </div>
                            <div class="score-item-value">${result.gameScore}/50</div>
                        </div>
                        
                        <h3 class="section-title" style="margin-top: 1.5rem;">ë¯¸ë‹ˆê²Œì„ë³„ ê¸°ë¡</h3>
                        <div class="minigame-scores">
                            ${state.miniGameScores.map(s => `
                                <div class="minigame-score-item">
                                    <div class="minigame-score-value">${s.type === 'reaction' ? s.score + 'ms' : s.type === 'timing' ? Math.abs(s.score) + 'px' : s.score + 'ì '}</div>
                                    <div class="minigame-score-label">${minigameNames[s.type]}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn action-btn-primary" onclick="window.location.reload()">ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°</button>
                    </div>
                </div>
            `;
        }


        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        function handleStart(count) {
            state.questionCount = count;
            state.selectedQuestions = getRandomQuestions(count);
            state.currentQuestion = 0;
            state.answers = [];
            state.answerTimes = [];
            state.miniGameScores = [];
            state.stage = 'questions';
            render();
        }

        function checkGameCompletion() {
            const minigamePositions = getMiniGamePositions(state.questionCount);
            
            if (minigamePositions.includes(state.currentQuestion) && state.miniGameScores.length < minigamePositions.length) {
                // ë¯¸ë‹ˆ ê²Œì„ì´ í•„ìš”í•œ ìœ„ì¹˜ì¼ ë•Œ
                state.stage = 'minigame';
                const games = ['reaction', 'timing', 'rhythm'];
                state.currentMiniGame = games[state.miniGameScores.length];

                // ë¯¸ë‹ˆê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
                state.reactionStage = 'waiting';
                state.timingStopped = false;
                state.timingResult = null;
                state.timingPosition = 0;
                state.timingDirection = 1;
                state.rhythmScore = 0;
                state.rhythmCombo = 0;
                state.rhythmNotes = [];
                state.rhythmGameTime = 0;
                
            } else if (state.currentQuestion >= state.selectedQuestions.length) {
                state.stage = 'result';
            } else {
                state.stage = 'questions'; // ë‹¤ìŒ ì§ˆë¬¸
            }
            render();
        }

        function handleAnswer(answer) {
            state.answers.push({ question: state.selectedQuestions[state.currentQuestion].question, answer: answer });
            state.answerTimes.push(Date.now() - state.questionStartTime);

            state.currentQuestion++;
            
            // ë‹¤ìŒ ë‹¨ê³„ ê²°ì • ë¡œì§
            checkGameCompletion();
        }

        // =========================================================================
        // âš¡ ë°˜ì‘ì†ë„ ê²Œì„ ë¡œì§ (ìˆ˜ì •ëœ ë¶€ë¶„)
        // =========================================================================

        // Reaction Game Logic (Start is implicitly called by render)
        function startReactionGame() {
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë“±ë¡ ë°©ì§€
            const gameArea = document.getElementById('reaction-game-area');
            if (gameArea && !gameArea.dataset.listenerAttached) {
                gameArea.addEventListener('click', handleReactionClick);
                gameArea.dataset.listenerAttached = 'true';
            }
        }

        function handleReactionClick() {
            if (reactionTimeout) {
                clearTimeout(reactionTimeout);
                reactionTimeout = null;
            }

            if (state.reactionStage === 'waiting') {
                // 1. 'waiting' (í´ë¦­í•´ì„œ ì‹œì‘) ìƒíƒœ: í´ë¦­í•˜ë©´ 'ready'ë¡œ ì „í™˜
                state.reactionStage = 'ready';
                render(); 

                // 2. 'ready' ìƒíƒœì—ì„œ 'GO' ìƒíƒœë¡œ ë„˜ì–´ê°ˆ ì‹œê°„ ì„¤ì • (1ì´ˆ ~ 4ì´ˆ)
                const delay = Math.random() * 3000 + 1000; 
                
                reactionTimeout = setTimeout(() => {
                    state.reactionStage = 'go';
                    state.reactionStartTime = Date.now(); // GOê°€ ëœ ì‹œê°„ ê¸°ë¡
                    render(); // 'ì§€ê¸ˆ í´ë¦­!' í™”ë©´ (ì´ˆë¡ìƒ‰)ìœ¼ë¡œ ì „í™˜
                }, delay);

            } else if (state.reactionStage === 'ready') {
                // 3. 'ready' (ì¤€ë¹„) ìƒíƒœì—ì„œ í´ë¦­: ë„ˆë¬´ ë¹ ë¦„
                state.reactionStage = 'tooEarly';
                state.reactionTime = 0;
                render(); // 'ë„ˆë¬´ ë¹¨ë¼ìš”!' í™”ë©´ìœ¼ë¡œ ì „í™˜
                
                // 1ì´ˆ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
                setTimeout(() => {
                    const gameArea = document.getElementById('reaction-game-area');
                    if (gameArea) gameArea.removeEventListener('click', handleReactionClick);
                    state.miniGameScores.push({ type: 'reaction', score: 9999 }); // ì‹¤íŒ¨ ì‹œ ì•„ì£¼ ë†’ì€ ì ìˆ˜ë¡œ ê¸°ë¡
                    goToNextMiniGame();
                }, 1000); 

            } else if (state.reactionStage === 'go') {
                // 4. 'go' (í´ë¦­!) ìƒíƒœì—ì„œ í´ë¦­: ì„±ê³µ
                state.reactionStage = 'result';
                state.reactionTime = Date.now() - state.reactionStartTime; // ë°˜ì‘ ì‹œê°„ ê³„ì‚°
                state.miniGameScores.push({ type: 'reaction', score: state.reactionTime });
                render(); // ê²°ê³¼ í™”ë©´ í‘œì‹œ

                // 2ì´ˆ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
                setTimeout(() => {
                    const gameArea = document.getElementById('reaction-game-area');
                    if (gameArea) gameArea.removeEventListener('click', handleReactionClick);
                    goToNextMiniGame();
                }, 2000); 
            }
        }
        
        // =========================================================================
        // ğŸ¯ íƒ€ì´ë° ê²Œì„ ë¡œì§
        // =========================================================================

        // íƒ€ì´ë° ë°” ì—…ë°ì´íŠ¸ ë£¨í”„
        function updateTimingBar() {
            if (state.timingStopped || state.timingResult !== null) return;
            
            const speed = 1.5; // ì†ë„ ì¡°ì ˆ
            state.timingPosition += state.timingDirection * speed; 
            
            if (state.timingPosition >= 100) {
                state.timingDirection = -1;
            } else if (state.timingPosition <= 0) {
                state.timingDirection = 1;
            }
            
            const bar = document.getElementById('timing-bar');
            if (bar) {
                bar.style.transform = `translateX(${state.timingPosition}%)`;
            }
            timingAnimationId = requestAnimationFrame(updateTimingBar);
        }

        // ê²Œì„ ì‹œì‘/ì¬ê°œ
        function startTimingGame() {
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('keydown', handleKeydownTiming, { once: true });
            
            if (state.timingResult === null && !state.timingStopped) {
                // ë Œë”ë§ í›„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
                setTimeout(() => {
                    cancelAnimationFrame(timingAnimationId);
                    timingAnimationId = requestAnimationFrame(updateTimingBar);
                }, 100);
            } else if (state.timingResult !== null) {
                 // ê²°ê³¼ í™”ë©´ì´ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ ìë™ ì´ë™ (ë²„íŠ¼ ëˆ„ë¥¼ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ëŒ€ì‹ )
                 setTimeout(goToNextMiniGame, 2000);
            }
        }
        
        // ìŠ¤í˜ì´ìŠ¤ë°” ì…ë ¥ ì²˜ë¦¬
        function handleKeydownTiming(event) {
            if (event.code === 'Space' && state.stage === 'minigame' && state.currentMiniGame === 'timing' && state.timingResult === null) {
                event.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
                handleTimingStop();
            } else {
                // ë‹¤ë¥¸ í‚¤ê°€ ëˆŒë¦¬ë©´ ë‹¤ì‹œ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                document.addEventListener('keydown', handleKeydownTiming, { once: true });
            }
        }

        // íƒ€ì´ë° ë©ˆì¶¤
        function handleTimingStop() {
            if (state.timingStopped || state.timingResult !== null) return;
            
            cancelAnimationFrame(timingAnimationId);
            state.timingStopped = true;

            // ì¤‘ì•™ì€ 50%, ë§‰ëŒ€ ë„ˆë¹„ 1rem=5px (24rem = 384px. 50%ëŠ” 192px)
            // ë§‰ëŒ€ëŠ” 0% ~ 100% ì´ë™. ì¤‘ì•™ 50% ê¸°ì¤€ ì˜¤ì°¨ ê³„ì‚° (ì´í•´í•˜ê¸° ì‰½ê²Œ í”½ì…€ë¡œ ë³€í™˜í•˜ì§€ ì•Šê³  0~100 ì‚¬ì´ì˜ ê°’ìœ¼ë¡œ ì‚¬ìš©)
            const targetPosition = 50;
            const diff = state.timingPosition - targetPosition;

            state.timingResult = diff; // ì¤‘ì•™ 50ì—ì„œ ì–¼ë§ˆë‚˜ ë²—ì–´ë‚¬ëŠ”ì§€ (ìŒìˆ˜=ì™¼ìª½, ì–‘ìˆ˜=ì˜¤ë¥¸ìª½)
            state.miniGameScores.push({ type: 'timing', score: diff });

            // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
            setTimeout(goToNextMiniGame, 2000); 

            render();
        }

        // =========================================================================
        // ğŸ¶ ë¦¬ë“¬ ê²Œì„ ë¡œì§
        // =========================================================================
        let nextNoteTime = 0;
        let noteIdCounter = 0;
        const NOTE_HIT_LINE = 90; // íƒ€ê²Ÿ ë¼ì¸ ìœ„ì¹˜ (í¼ì„¼íŠ¸)
        const HIT_WINDOW_MS = 150; // ë…¸íŠ¸ë¥¼ ë§ì¶œ ìˆ˜ ìˆëŠ” ì‹œê°„ ë²”ìœ„ (ms)

        function startRhythmGame() {
            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì´ì „ì— ë“±ë¡ë˜ì—ˆì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ì œê±° í›„ ë‹¤ì‹œ ë“±ë¡)
            document.removeEventListener('keydown', handleKeydownRhythm);
            document.addEventListener('keydown', handleKeydownRhythm);

            // ê¸°ì¡´ ì¸í„°ë²Œ ë° ìƒì„±ê¸° í´ë¦¬ì–´
            if (rhythmGameInterval) clearInterval(rhythmGameInterval);
            if (rhythmNoteGenerator) clearInterval(rhythmNoteGenerator);

            // ê²Œì„ ì‹œê°„ ì´ˆê¸°í™”
            state.rhythmGameTime = 0;
            nextNoteTime = 0;
            noteIdCounter = 0;
            state.rhythmNotes = [];

            // ë…¸íŠ¸ ìƒì„±ê¸° (1ì´ˆë§ˆë‹¤ ë…¸íŠ¸ ìƒì„±)
            rhythmNoteGenerator = setInterval(() => {
                if (state.rhythmGameTime < 10000) { // 10ì´ˆ ë™ì•ˆë§Œ ìƒì„±
                    const noteTime = state.rhythmGameTime + 1000; // 1ì´ˆ ë’¤ì— ë¼ì¸ì— ë„ì°©í•  ë…¸íŠ¸
                    state.rhythmNotes.push({ id: noteIdCounter++, time: noteTime, hitStatus: 'missable' });
                    render(); // ë…¸íŠ¸ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ê¸° ìœ„í•´ ë Œë”ë§
                } else {
                    clearInterval(rhythmNoteGenerator);
                }
            }, 1000); 

            // ë©”ì¸ ê²Œì„ ë£¨í”„ (50ms ë§ˆë‹¤ ì—…ë°ì´íŠ¸)
            const startTime = Date.now();
            rhythmGameInterval = setInterval(() => {
                state.rhythmGameTime = Date.now() - startTime;
                
                // ì‹œê°„ì´ ì§€ë‚œ ë…¸íŠ¸ ì •ë¦¬ ë° missed ì²˜ë¦¬
                state.rhythmNotes = state.rhythmNotes.filter(note => {
                    const diff = note.time - state.rhythmGameTime;
                    if (diff < -HIT_WINDOW_MS && note.hitStatus === 'missable') {
                        // ë†“ì¹œ ë…¸íŠ¸
                        state.rhythmCombo = 0;
                        note.hitStatus = 'missed';
                        return false; // í™”ë©´ì—ì„œ ì œê±°
                    }
                    if (diff < -500) { // ë„ˆë¬´ ì˜¤ë˜ ì§€ë‚œ ë…¸íŠ¸ ì œê±°
                        return false;
                    }
                    return true;
                });

                render(); // í™”ë©´ ì—…ë°ì´íŠ¸

                if (state.rhythmGameTime >= 10000 && state.rhythmNotes.length === 0) {
                    clearInterval(rhythmGameInterval);
                    document.removeEventListener('keydown', handleKeydownRhythm);
                    state.miniGameScores.push({ type: 'rhythm', score: state.rhythmScore });
                    setTimeout(goToNextMiniGame, 1000);
                }

            }, 50);
        }

        function handleKeydownRhythm(event) {
            if (event.code === 'Space' && state.stage === 'minigame' && state.currentMiniGame === 'rhythm') {
                event.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
                
                // í˜„ì¬ ë¼ì¸ì— ê°€ì¥ ê°€ê¹Œìš´ 'missable' ë…¸íŠ¸ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                const targetNoteIndex = state.rhythmNotes.findIndex(note => 
                    note.hitStatus === 'missable' && Math.abs(note.time - state.rhythmGameTime) <= HIT_WINDOW_MS * 2
                );

                if (targetNoteIndex !== -1) {
                    const note = state.rhythmNotes[targetNoteIndex];
                    const diff = Math.abs(note.time - state.rhythmGameTime);
                    let points = 0;
                    let feedback = '';

                    // ì ìˆ˜ ê³„ì‚°
                    if (diff <= HIT_WINDOW_MS * 0.3) { // 45ms ì´ë‚´
                        points = 3; 
                        feedback = 'PERFECT';
                    } else if (diff <= HIT_WINDOW_MS * 0.7) { // 105ms ì´ë‚´
                        points = 2; 
                        feedback = 'GOOD';
                    } else if (diff <= HIT_WINDOW_MS) { // 150ms ì´ë‚´
                        points = 1; 
                        feedback = 'OK';
                    } else {
                        return; // íˆíŠ¸ ìœˆë„ìš°ë¥¼ ë²—ì–´ë‚¨
                    }

                    // ë…¸íŠ¸ ì²˜ë¦¬
                    note.hitStatus = 'hit';
                    state.rhythmScore += points * (state.rhythmCombo + 1); // ì½¤ë³´ ë³´ë„ˆìŠ¤
                    state.rhythmCombo++;
                    state.rhythmFeedback = feedback;
                    
                    // í”¼ë“œë°± í…ìŠ¤íŠ¸ ì œê±° íƒ€ì´ë¨¸
                    setTimeout(() => {
                        state.rhythmFeedback = '';
                        render();
                    }, 500);

                    // í™”ë©´ì—ì„œ ë…¸íŠ¸ ì¦‰ì‹œ ì œê±°
                    setTimeout(() => {
                        state.rhythmNotes.splice(targetNoteIndex, 1);
                        render();
                    }, 100); 

                } else {
                    // ì˜ëª»ëœ íƒ€ì´ë°ì— í´ë¦­: ì½¤ë³´ ë¦¬ì…‹
                    state.rhythmCombo = 0;
                    state.rhythmFeedback = 'MISS';
                     setTimeout(() => {
                        state.rhythmFeedback = '';
                        render();
                    }, 500);
                }
                
                render();
            }
        }

        // =========================================================================
        // ë©”ì¸ íë¦„ ì œì–´
        // =========================================================================

        function goToNextMiniGame() {
            // ê²Œì„ë³„ íƒ€ì´ë¨¸/ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
            if (reactionTimeout) clearTimeout(reactionTimeout);
            if (timingAnimationId) cancelAnimationFrame(timingAnimationId);
            document.removeEventListener('keydown', handleKeydownTiming);
            if (rhythmGameInterval) clearInterval(rhythmGameInterval);
            if (rhythmNoteGenerator) clearInterval(rhythmNoteGenerator);
            document.removeEventListener('keydown', handleKeydownRhythm);


            const minigamePositions = getMiniGamePositions(state.questionCount);
            const totalGames = minigamePositions.length;
            const currentGamesCompleted = state.miniGameScores.length;

            if (currentGamesCompleted < totalGames) {
                // ë‹¤ìŒ ë¯¸ë‹ˆ ê²Œì„ìœ¼ë¡œ ì´ë™ (checkGameCompletionì—ì„œ ì²˜ë¦¬)
                state.stage = 'questions'; // ì„ì‹œë¡œ ì§ˆë¬¸ìœ¼ë¡œ ëŒë¦° í›„
            } else {
                // ëª¨ë“  ë¯¸ë‹ˆ ê²Œì„ ì™„ë£Œ í›„, ì§ˆë¬¸ ë‹¨ê³„ë¡œ ë³µê·€í•˜ê±°ë‚˜ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì´ë™
                state.stage = 'questions'; 
            }
            
            // ë‹¤ìŒ ì§ˆë¬¸ ë˜ëŠ” ìµœì¢… ê²°ê³¼ë¡œ ì´ë™
            checkGameCompletion();
        }

        // ì´ˆê¸° ë Œë”ë§
        render();

        // ì´ˆê¸°í™” ì‹œ ë¶ˆí•„ìš”í•˜ê²Œ ë‚¨ì•„ìˆëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•©ë‹ˆë‹¤.
        window.onload = function() {
             document.removeEventListener('keydown', handleKeydownTiming);
             document.removeEventListener('keydown', handleKeydownRhythm);
        }

    </script>
</body>
</html>
